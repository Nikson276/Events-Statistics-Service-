x-clickhouse-config: &clickhouse-config
  image: clickhouse/clickhouse-server:23
  networks:
    - ess-net

x-consumer-template: &consumer-template
  build: .
  profiles: ["consumers"]  # Для ручного запуска
  networks:
    - ess-net
  command: ["python", "-m", "ess.kafka_consumer.main"]
  restart: on-failure

services:
  # =============== ZOOKEEPER (для ClickHouse) ===============
  zookeeper:
    image: zookeeper:3.8
    container_name: zookeeper
    hostname: zookeeper
    networks:
      - ess-net

  # =============== CLICKHOUSE CLUSTER (4 nodes) ===============
  clickhouse-node1:
    <<: *clickhouse-config
    container_name: clickhouse-node1
    hostname: clickhouse-node1
    ports:
      - "9000:9000"  # ← должен быть открыт для clickhouse-driver
      - "8123:8123"  # ← для aiochclient
    volumes:
      - ./clickhouse-config/node1:/etc/clickhouse-server
    depends_on:
      - zookeeper

  clickhouse-node2:
    <<: *clickhouse-config
    container_name: clickhouse-node2
    hostname: clickhouse-node2
    ports:
      - "8124:8123"
      - "9001:9000"
    volumes:
      - ./clickhouse-config/node2:/etc/clickhouse-server
    depends_on:
      - zookeeper

  clickhouse-node3:
    <<: *clickhouse-config
    container_name: clickhouse-node3
    hostname: clickhouse-node3
    ports:
      - "8125:8123"
      - "9002:9000"
    volumes:
      - ./clickhouse-config/node3:/etc/clickhouse-server
    depends_on:
      - zookeeper

  clickhouse-node4:
    <<: *clickhouse-config
    container_name: clickhouse-node4
    hostname: clickhouse-node4
    ports:
      - "8126:8123"
      - "9003:9000"
    volumes:
      - ./clickhouse-config/node4:/etc/clickhouse-server
    depends_on:
      - zookeeper

  # =============== KAFKA CLUSTER (3 nodes, KRaft) ===============
  kafka-0:
    image: apache/kafka:3.7.0
    container_name: kafka-0
    hostname: kafka-0
    ports:
      - "9094:9094"
    environment:
      CLUSTER_ID: "abcdefghijklmnopqrstuv"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 0
      KAFKA_CONTROLLER_QUORUM_VOTERS: "0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9094"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-0:9092,EXTERNAL://localhost:9094"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_CFG_NUM_NETWORK_THREADS: 8
      KAFKA_CFG_NUM_IO_THREADS: 16
      KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES: 2097152
      KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES: 2097152
      KAFKA_CFG_NUM_REPLICA_FETCHERS: 4
    volumes:
      - kafka_0_data:/var/lib/kafka/data
    networks:
      - ess-net

  kafka-1:
    image: apache/kafka:3.7.0
    container_name: kafka-1
    hostname: kafka-1
    ports:
      - "9095:9095"
    environment:
      CLUSTER_ID: "abcdefghijklmnopqrstuv"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: "0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9095"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-1:9092,EXTERNAL://localhost:9095"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_CFG_NUM_NETWORK_THREADS: 8
      KAFKA_CFG_NUM_IO_THREADS: 16
      KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES: 2097152
      KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES: 2097152
      KAFKA_CFG_NUM_REPLICA_FETCHERS: 4
    volumes:
      - kafka_1_data:/var/lib/kafka/data
    networks:
      - ess-net

  kafka-2:
    image: apache/kafka:3.7.0
    container_name: kafka-2
    hostname: kafka-2
    ports:
      - "9096:9096"
    environment:
      CLUSTER_ID: "abcdefghijklmnopqrstuv"
      KAFKA_PROCESS_ROLES: "broker,controller"
      KAFKA_NODE_ID: 2
      KAFKA_CONTROLLER_QUORUM_VOTERS: "0@kafka-0:9093,1@kafka-1:9093,2@kafka-2:9093"
      KAFKA_LISTENERS: "PLAINTEXT://:9092,CONTROLLER://:9093,EXTERNAL://:9096"
      KAFKA_ADVERTISED_LISTENERS: "PLAINTEXT://kafka-2:9092,EXTERNAL://localhost:9096"
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: "CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT"
      KAFKA_CONTROLLER_LISTENER_NAMES: "CONTROLLER"
      KAFKA_LOG_DIRS: "/var/lib/kafka/data"
      KAFKA_CFG_NUM_NETWORK_THREADS: 8
      KAFKA_CFG_NUM_IO_THREADS: 16
      KAFKA_CFG_SOCKET_SEND_BUFFER_BYTES: 2097152
      KAFKA_CFG_SOCKET_RECEIVE_BUFFER_BYTES: 2097152
      KAFKA_CFG_NUM_REPLICA_FETCHERS: 4
    volumes:
      - kafka_2_data:/var/lib/kafka/data
    networks:
      - ess-net

  # =============== KAFKA UI ===============
  kafka-ui:
    image: provectuslabs/kafka-ui:v0.7.0
    container_name: kafka-ui
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_CLUSTERS_0_NAME=kraft
    networks:
      - ess-net
    depends_on:
      - kafka-0

  # =============== INIT SERVICE (создаёт схемы) ===============
  init-schemas:
    build: .
    container_name: init-schemas
    networks:
      - ess-net
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=9000
    command: ["python", "-m", "ess.scripts.init_all"]

  # =============== FASTAPI ===============
  fastapi:
    build: .
    container_name: fastapi
    ports:
      - "8000:8000"
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_TOPIC=nikson-test
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=8123
    networks:
      - ess-net
    depends_on:
      init-schemas:
        condition: service_completed_successfully
    command: ["uvicorn", "ess.app.main:app", "--host", "0.0.0.0", "--port", "8000", "--workers", "8"]


  # =============== KAFKA CONSUMERs ===============
  consumer-1:
    <<: *consumer-template
    container_name: consumer-1
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_TOPIC=nikson-test
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=8123

  consumer-2:
    <<: *consumer-template
    container_name: consumer-2
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_TOPIC=nikson-test
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=8123

  consumer-3:
    <<: *consumer-template
    container_name: consumer-3
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_TOPIC=nikson-test
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=8123

  consumer-4:
    <<: *consumer-template
    container_name: consumer-4
    environment:
      - KAFKA_BOOTSTRAP_SERVERS=kafka-0:9092
      - KAFKA_TOPIC=nikson-test
      - CLICKHOUSE_HOST=clickhouse-node1
      - CLICKHOUSE_PORT=8123


  # =============== Grafana Pyroscope ===============
  pyroscope:
    image: grafana/pyroscope:latest
    container_name: pyroscope
    ports:
      - "4040:4040"  # Веб-интерфейс
      - "4041:4041"  # gRPC API (для агентов)
    command:
      - "server"
    networks:
      - ess-net
    volumes:
      - pyroscope_:/data  # сохранение данных между перезапусками

  # =============== Grafana K6 ===============
  k6:
    image: grafana/k6:latest
    container_name: k6
    volumes:
      - ./k6:/scripts  # монтируем папку со скриптами
    networks:
      - ess-net
    command: ["run", "/scripts/load-test.js"]
    profiles: ["load-test"]

# =============== VOLUMES ===============
volumes:
  kafka_0_data:
  kafka_1_data:
  kafka_2_data:
  pyroscope_:

# =============== NETWORK ===============
networks:
  ess-net:
    driver: bridge